---
title: "**Exploring OABS Relationships**"
author: "Phillip Desrochers"
output:
  html_document:
    # number_sections: TRUE
    css: style.css
    keep_md: true
    df_print: paged
    code_folding: hide
    toc: true
    toc_float: true
    theme: spacelab
    includes:
      before_body: header.html
      after_body: footer.html
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(knitr)
library(DT)
library(writexl)

```

<style>
#TOC {
  background: url("https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcTzCXJ6LbQeZesE-xzMa-sN6dePmdkWzXHhhg&usqp=CAU");
  background-size: contain;
  padding-top: 130px !important;
  background-repeat: no-repeat;
}
</style>

# **Introduction**

***

This project cleans and merges data from the bariatric surgery group at Boston Medical Center and the BU Motor Development Lab to explore relationships between demographic/questionnaire/movement data. These data are de-identified and comply with HIPAA regulations.


```{r read_in_and_deID_data, include = FALSE}

rm(list = ls())

BMC_data = as_tibble(read.csv("oabs_masterfile_060320_gill.csv", header = TRUE))
MDL_data = as_tibble(read.csv("MasterOABS_05-04-20.csv", header = TRUE))

# De-ID BMC data
BMC_data[c("V0SDT0", "V0SDT1")] = NULL
BMC_data = BMC_data %>%
  rename(Sub_ID = OABSID)

# De-ID MDL data
MDL_data = MDL_data %>%
  rename(Sub_ID = Ã¯..Sub_N)

write.csv(BMC_data, file = "BMC_data.csv", row.names = FALSE)
write.csv(MDL_data, file = "MDL_data.csv", row.names = FALSE)

rm(list = ls())

```

# **Let's [wrangle](https://en.wikipedia.org/wiki/Data_wrangling) some data!**

***

```{r haha, out.width = "50%", fig.align="center"}
include_graphics("C:/Users/philc/Google Drive/MDL/Projects/OABS-Explore/OABS-Explore/data_wrangling.jpg") 
```


## Deal with repeated SubNums in MDL

```{r read_in_and_clean_data, out.width = "50%", fig.align="center"}

BMC_data = as_tibble(read.csv("BMC_data.csv", header = TRUE))
MDL_data = as_tibble(read.csv("MDL_data.csv", header = TRUE))

MDL_data = MDL_data[-which(MDL_data$Sub_ID == 39),] # sub 39 is a single row and blank....
MDL_data = filter(MDL_data, Visit > 2) # filter only the people who had surgery (might change later)

# MDL_data$Condition = substr(MDL_data$Condition_N, 1, 1) # Isolating Condition
# MDL_data$Condition_N = NULL

# Clean trial variable (some are 1, 2, 3, others are 101, 102, 103, etc)
MDL_data$Trial = 80085
# MDL_data$Trial_N = as.character(MDL_data$Trial_N)
for (i in 1:nrow(MDL_data)) {
  if (is.na(MDL_data$Trial_N[i])) {
    MDL_data$Trial[i] = NA
  } else if (nchar(MDL_data$Trial_N[i]) == 3) {
    MDL_data$Trial[i] = as.integer(substr(MDL_data$Trial_N[i], 2, 3)) # Isolating Trial
  } else {
    MDL_data$Trial[i] = MDL_data$Trial_N[i]
  }
}


# rename vars
BMC_data = BMC_data %>%
  rename(Age = V0AGE, # wellll this will take approx 1 billion years...will come back to this later or find a more efficient way
         Sex = SEX,
         Hisp = HISP,
         Race = RACE,
         Race_Asian = Race_ASIAN,
         Education_lev = V0EDUC,
         Work_for_pay = V0PAY,
         Procedure = V0TRGRP,
         Walk_freely = V0WALKelig,
         Knee_pain = V0KNPN,
         Knee_pain_which = V0KNPNK,
         Knee_pain_most = V0KNPNKP,
         Knee_surg = V0KNSUG,
         Knee_surg_which = V0KNSUGKs,
         Knee_surg_otherKneeInPain = V0KNSUGKb)     

```

Here's a breakdown of possible duplicates in the MDL dataset.  I tried to determine how many unique age and height values were associated with a single subject number.  Note that the subjects included here are the subs that are shared by BOTH datasets ONLY.

<br>

```{r duplicate MDL Subs}

# Per Simone, participants who have 4-month, 8-month, and 16-month visits, they can ONLY be from the MGH center
MDL_data = MDL_data %>%
  mutate(Center = if_else(Visit == 4 | Visit == 5 | Visit == 7, "MGH", "Unknown"))
MDL_data$Sub_ID_new = MDL_data$Sub_ID

# Now, separate out height/age for MDL people recruited from MGH
MGH_subs = MDL_data %>%
  select(Sub_ID, Height, Age, Center) %>%
  filter(Center == "MGH") %>%
  distinct()

# for each row, determine if height row matches corresponding MGH subject number. If so, mark Sub_ID as such to distinguish
for (i in 1:nrow(MDL_data)) {
  
  SubNum = MDL_data$Sub_ID[i]
  SubHeight = MDL_data$Height[i]
  SubAge = MDL_data$Age[i]
  
  MGH_subs_temp = MGH_subs %>%
    filter(Sub_ID == SubNum)
  
  # if (nrow(MGH_subs_temp)>0 & !is.na(SubAge) & !is.na(SubHeight) & !is.na(MGH_subs_temp$Age[i]) & !is.na(MGH_subs_temp$Height[i])) {
  #   for (j in nrow(MGH_subs_temp)) {
  #     if (MGH_subs_temp$Height[j] == SubHeight) { # & MGH_subs_temp$Age[i] == SubAge
  #       MDL_data$Sub_ID_new[i] = paste(MDL_data$Sub_ID[i], "_MGH", sep = "")
  #       MDL_data$Center[i] = "MGH"
  #     }
  #   }
  # }
  
  if (SubHeight %in% MGH_subs_temp$Height) {
    MDL_data$Sub_ID_new[i] = paste(MDL_data$Sub_ID[i], "_MGH", sep = "")
    MDL_data$Center[i] = "MGH"
  }
  
}

# Determine what subjects are contained in each dataset at this point
BMC_subList = levels(as.factor(BMC_data$Sub_ID))
MDL_subList = levels(as.factor(MDL_data$Sub_ID))
subs_in_both = intersect(MDL_subList, BMC_subList)
subs_in_MDL_only = setdiff(MDL_subList, BMC_subList)


# Now figure out who EXACTLY MATCH subs in the BMC dataset
BMC_subs = BMC_data %>%
  filter(Sub_ID %in% subs_in_both) %>%
  select(Sub_ID, Age, V0HTCM)
colnames(BMC_subs)[3] = "Height"

for (i in 1:nrow(MDL_data)) {
  
  SubNum = MDL_data$Sub_ID[i]
  SubHeight = MDL_data$Height[i]
  
  # IF subnum is shared between datasets
  if (SubNum %in% subs_in_both) {
    BMC_subs_temp = BMC_subs %>%
      filter(Sub_ID == SubNum)
    
    # IF there is a height number
    if (!is.na(MDL_data$Height[i])) {
      
      #IF the MDL height matches the BMC Height AND IF the Subject has not yet been categorized
      if (MDL_data$Height[i] == BMC_subs_temp$Height & MDL_data$Center[i] == "Unknown") {
        MDL_data$Sub_ID_new[i] = paste(MDL_data$Sub_ID[i], "_BMC", sep = "")
        MDL_data$Center[i] = "BMC"
      }
    }
  }
}


# SO subID 18 is a fuck and has the at least two people same height, but those people's sessions also cross a year, and none of it matches with the BMC data lol.  GAHHH.  so there are like 4 different ages but all the same height.  This doesn't fall into any regular situation.  Anyways, I'm like 90% sure the subID 18 that's 41/43 years old is the BMC person, so I'm just going to manually change it here.  Fuck this dataset.

for (i in 1:nrow(MDL_data)) {
  if (MDL_data$Sub_ID[i] == "18_MGH" & MDL_data$Age[i] < 60) {
    MDL_data$Sub_ID_new [i] = "18_BMC"
    MDL_data$Center[i] = "BMC"
  }
}

# Unmatched at this point
unmatched = MDL_data %>%
  filter(Center == "Unknown") %>% # Note, "Unknown" COULD still have been recruited from BMC or MGH
  select(Sub_ID) %>%
  distinct()


MDL_subs_fromBMC = MDL_data %>%
  filter(Center == "BMC") %>%
  select(Sub_ID) %>%
  distinct()

unmatched_maybe_from_BMC = unlist(setdiff(unmatched, MDL_subs_fromBMC)) #find subs who aren't matched that have unique SubID from subs that have already been ID'd as BMC subs
unmatched_maybe_from_BMC = intersect(BMC_subs$Sub_ID, unmatched_maybe_from_BMC) #find subnums that overlap with BMC data


# For subs contained in both MDL and BMC data, find if there are still duplicates
source("func_findDuplicates.R")

maybe_duplicates = as_tibble(data.frame(matrix(nrow = length(unmatched_maybe_from_BMC), ncol = 9)))
colnames(maybe_duplicates) = c("SubNum", "MDL_numAges", "MDL_Ages", "MDL_numHeights", "MDL_Heights", "BMC_numAges", "BMC_Ages", "BMC_numHeights", "BMC_Heights")

for (i in 1:length(unmatched_maybe_from_BMC)) {
  duplicate_temp = findDuplicates(unmatched_maybe_from_BMC[i])

  maybe_duplicates$SubNum[i] = duplicate_temp[1]
  maybe_duplicates$MDL_numAges[i] = duplicate_temp[2]
  maybe_duplicates$MDL_Ages[i] = duplicate_temp[3]
  maybe_duplicates$MDL_numHeights[i] = duplicate_temp[4]
  maybe_duplicates$MDL_Heights[i] = duplicate_temp[5]
  maybe_duplicates$BMC_numAges[i] = duplicate_temp[6]
  maybe_duplicates$BMC_Ages[i] = duplicate_temp[7]
  maybe_duplicates$BMC_numHeights[i] = duplicate_temp[8]
  maybe_duplicates$BMC_Heights[i] = duplicate_temp[9]
}

maybe_duplicates_table = datatable(maybe_duplicates, rownames = FALSE, filter="top", options = list(pageLength = 25, scrollX=T))
maybe_duplicates_table

# DT::saveWidget(maybe_duplicates_table, "ChooseSubs.html")

# Based on these results, subs 40, 56, 57, 60, 61, 62, 63, 64 (x2), 67, 68 (x2), 74, 75, 79, 84 (x2) are not classified.  Per discussions with Simone, we've decided that we'll subnums that have <= 2 years difference in age and <= 2 cm difference in height between MDL and BMC datasets will be considered actually the same subject.  9/14/20

# subs that don't make the cut: 60, 64 (x2), 67, 68 (age 37 only; age 34 is IN), 79, 84 (age 54 only, age 50 is IN)

#Sub 68 remains a duplicate; the one with age of 34 is going to be identified as the sub that stays in to match with the BMC sub.
MDL_data$Center[which(MDL_data$Sub_ID_new == "68" & MDL_data$Age == 34)] = "BMC"
MDL_data$Sub_ID_new[which(MDL_data$Sub_ID_new == "68" & MDL_data$Age == 34)] = paste(MDL_data$Sub_ID_new[which(MDL_data$Sub_ID_new == "68" & MDL_data$Age == 34)], "_BMC", sep = "")

#Sub 84 remains a duplicate; the one with age of 50 is going to be identified as the sub that stays in to match with the BMC sub.
MDL_data$Center[which(MDL_data$Sub_ID_new == "84" & MDL_data$Age == 50)] = "BMC"
MDL_data$Sub_ID_new[which(MDL_data$Sub_ID_new == "84" & MDL_data$Age == 50)] = paste(MDL_data$Sub_ID_new[which(MDL_data$Sub_ID_new == "84" & MDL_data$Age == 50)], "_BMC", sep = "")

#These subs are singles, and remain IN
inSubs = as.character(c(40, 56, 57, 61, 62, 63, 74, 75))

for (i in inSubs){
  MDL_data$Center[which(MDL_data$Sub_ID_new == inSubs[i])] = "BMC"
  MDL_data$Sub_ID_new[which(MDL_data$Sub_ID_new == inSubs[i])] = paste(MDL_data$Sub_ID_new[which(MDL_data$Sub_ID_new == inSubs[i])], "_BMC", sep = "")
}

# This SHOULD be the data that contains ONLY subjects that originated from BMC
MDL_data_clean = MDL_data %>%
  filter(Center == "BMC")

# Now, get our final sub counts
BMC_subList = levels(as.factor(BMC_data$Sub_ID))
MDL_subList = levels(as.factor(MDL_data_clean$Sub_ID))
subs_in_both = intersect(MDL_subList, BMC_subList)
subs_in_MDL_only = setdiff(MDL_subList, BMC_subList)

```

<br>



***

## Who is in what dataset?

<br>

In the BMC dataset, there are `r length(BMC_subList)` subjects:
```{r}
BMC_subList
```

<br>

In the MDL dataset, there are `r length(MDL_subList)` subjects:
```{r}
MDL_subList
```

<br>

*Thus, there are __`r length(intersect(MDL_subList, BMC_subList))`__ subjects shared across datasets*:
```{r}
subs_in_both
```

<br>

Now, there are ***`r length(subs_in_MDL_only)`*** participants who ARE included in the MDL data, but ARE NOT in the BMC data:
```{r}
subs_in_MDL_only
```

***

## What MDL visits attended?

* 1 = Control cross-sectional (Ctl_CS)
* 2 = Overweight cross-sectional (OW_CS)
* 3 = pre-surgery (pre)
* 4 = 4 months post-surgery (fourMonths)
* 5 = 8 months post-surgery (eightMonths)
* 6 = 12 months post-surgery (twelveMonths)
* 7 = 16 months post-surgery (sixteenMonths)

```{r MDL_visit_info}

source('func_getVisitInfo.R')

MDL_visit_info = data.frame(matrix(NA, nrow = length(MDL_subList), ncol = 8))

# Change Variable Names
names(MDL_visit_info) <- c("Sub_ID", "Ctl_CS", "OW_CS", "pre", "fourMonths", "eightMonths", "twelveMonths", "sixteenMonths")
MDL_visit_info$Sub_ID = as.integer(MDL_visit_info$Sub_ID)

MDL_visit_data = MDL_data %>%
  select(Sub_ID, Visit)

for (i in 1:length(MDL_subList)) {
  MDL_visit_info$Sub_ID[i] = MDL_subList[i]
  MDL_visit_info$Ctl_CS[i] = getVisitInfo(MDL_subList[i], 1)
  MDL_visit_info$OW_CS[i] = getVisitInfo(MDL_subList[i], 2)
  MDL_visit_info$pre[i] = getVisitInfo(MDL_subList[i], 3)
  MDL_visit_info$fourMonths[i] = getVisitInfo(MDL_subList[i], 4)
  MDL_visit_info$eightMonths[i] = getVisitInfo(MDL_subList[i], 5)
  MDL_visit_info$twelveMonths[i] = getVisitInfo(MDL_subList[i], 6)
  MDL_visit_info$sixteenMonths[i] = getVisitInfo(MDL_subList[i], 7)
}

datatable(MDL_visit_info, rownames = FALSE, filter="top", options = list(pageLength = 10, scrollX=T))

```

<br>

```{r}
Ctl_CS_subList = filter(MDL_visit_info, Ctl_CS == TRUE)
OW_CS_subList = filter(MDL_visit_info, OW_CS == TRUE)
pre_subList = filter(MDL_visit_info, pre == TRUE)
fourMonths_subList = filter(MDL_visit_info, fourMonths == TRUE)
eightMonths_subList = filter(MDL_visit_info, eightMonths == TRUE)
twelveMonths_subList = filter(MDL_visit_info, twelveMonths == TRUE)
sixteenMonths_subList = filter(MDL_visit_info, sixteenMonths == TRUE)

noPre_subList = filter(MDL_visit_info, pre == FALSE)
```
**`r nrow(Ctl_CS_subList)`** participants have a "Control Cross-sectional" condition. They are: `r Ctl_CS_subList$Sub_ID`

<br>

**`r nrow(OW_CS_subList)`** participants have a "Overweight Cross-sectional" condition. They are: `r OW_CS_subList$Sub_ID`

<br>

**`r nrow(pre_subList)`** participants have a "Pre-Surgery" condition. They are: `r pre_subList$Sub_ID`

<br>

**`r nrow(fourMonths_subList)`** participants have a "Four Months Post-Surgery" condition. They are: `r fourMonths_subList$Sub_ID`

<br>

**`r nrow(eightMonths_subList)`** participants have a "Eight Months Post-Surgery" condition. They are: `r eightMonths_subList$Sub_ID`

<br>

**`r nrow(twelveMonths_subList)`** participants have a "Twelve Months Post-Surgery" condition. They are: `r twelveMonths_subList$Sub_ID`

<br>

**`r nrow(sixteenMonths_subList)`** participants have a "Sixteen Months Post-Surgery" condition. They are: `r sixteenMonths_subList$Sub_ID`

<br>

Additionally, **`r nrow(noPre_subList)`** participants did NOT have a "Pre-Surgery" condition. These subs also were NOT included in any followup conditions.  They are: `r noPre_subList$Sub_ID`.  These subs appear to be included in EITHER the Control OR Overweight cross-sectional conditions ONLY.

***

<!-- ## Does Subject info match between MDL and BMC? -->

```{r, include = FALSE}
BMC_ageData = BMC_data %>%
  select(Sub_ID, Age) %>%
  filter(Sub_ID %in% subs_in_both)
colnames(BMC_ageData)[2] = "BMC_Age"

MDL_ageData = MDL_data %>%
  select(Sub_ID, Age, Visit) %>%
  filter(Sub_ID %in% subs_in_both) %>%
  filter(Sub_ID %in% c(6, 8, 65, 66, 69, 70, 71, 81, 82, 85, 91) | Visit == 3) %>%
  select(Sub_ID, Age) %>%
  group_by(Sub_ID) %>%
  summarize(MDL_Age = mean(Age)) %>%
  filter(Sub_ID %in% subs_in_both)

AgeData = merge(BMC_ageData, MDL_ageData)

AgeData$Age_close = lapply(AgeData$BMC_Age, function(BMC_Age, MDL_Age) {
  Age_diff = abs(BMC_Age - MDL_Age)
  if(Age_diff <= 1.2) {
    return(TRUE)
  } else {
    return(FALSE)
  }
}, AgeData$MDL_Age)

```


```{r, include = FALSE}
# OABS_data = merge(BMC_demo_data, MDL_data, by = "Sub_ID")
#
# OABS_data = OABS_data %>%
#   arrange(Sub_ID, Visit, Condition, Trial_N)


```